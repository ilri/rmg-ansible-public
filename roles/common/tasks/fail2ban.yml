---

- name: Configure fail2ban sshd filter
  ansible.builtin.template:
    src: etc/fail2ban/jail.d/sshd.local.j2
    dest: /etc/fail2ban/jail.d/sshd.local
    owner: root
    mode: 0644
  notify: restart fail2ban

- name: Configure fail2ban nginx filter
  when: "extra_fail2ban_filters is defined and 'nginx' in extra_fail2ban_filters"
  ansible.builtin.template:
    src: etc/fail2ban/jail.d/nginx.local.j2
    dest: /etc/fail2ban/jail.d/nginx.local
    owner: root
    mode: 0644
  notify: restart fail2ban

# Only run this on hosts with newer fail2ban (>0.10.0?), which basically just
# excludes Ubuntu 16.04. The when logic here is not ideal, but I prefer to do
# it this way rather than making it much longer and more verbose. In my brief
# testing it seems older fail2ban versions restart slowly and have slightly
# different configuration semantics, so I'll just restrict to newer versions.
# Anyways, Ubuntu 16.04 is not even supported as of 2021-04 so there's no big
# deal really.
- name: Configure fail2ban apache filter
  when:
    - "(extra_fail2ban_filters is defined and 'apache' in extra_fail2ban_filters)"
    - ansible_distribution_version is version('16.04', '!=')
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    mode: 0644
  loop:
    - { src: 'etc/fail2ban/jail.d/apache.local.j2', dest: '/etc/fail2ban/jail.d/apache.local' }
    - { src: 'etc/fail2ban/filter.d/botsearch-common.local.j2', dest: '/etc/fail2ban/filter.d/botsearch-common.local' }
    - { src: 'etc/fail2ban/filter.d/apache-botsearch.local.j2', dest: '/etc/fail2ban/filter.d/apache-botsearch.local' }
    - { src: 'etc/fail2ban/filter.d/apache-proxy.local.j2', dest: '/etc/fail2ban/filter.d/apache-proxy.local' }
  notify: restart fail2ban

- name: Create fail2ban service override directory
  ansible.builtin.file:
    path: /etc/systemd/system/fail2ban.service.d
    state: directory
    owner: root
    mode: 0755

# See Arch Linux's example: https://wiki.archlinux.org/index.php/Fail2ban
- name: Configure fail2ban service override
  ansible.builtin.template:
    src: etc/systemd/system/fail2ban.service.d/override.conf.j2
    dest: /etc/systemd/system/fail2ban.service.d/override.conf
    owner: root
    mode: 0644
  notify:
    - reload systemd
    - restart fail2ban

- name: Start and enable fail2ban service
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: yes

# vim: set sw=2 ts=2:

---

- name: Configure SLURM
  import_tasks: slurm.yml
  tags: slurm

- name: Set extra packages fact for CentOS 7
  when: ansible_distribution_major_version is version('7','==')
  set_fact:
    extra_packages:
      - argtable.x86_64 # for clustalo
      - bcl2fastq2 # from Illumina, in ILRI repo
      - boost-devel.x86_64 # for augustus
      - boost-iostreams.x86_64 # for augustus
      - cairo-devel.x86_64 # for genometools and others
      - centos-release-scl # needed for newer compilers, etc
      - compat-libstdc++-33.x86_64 #for libstdc++.so.5
      - devtoolset-7-gcc # some software wants a newer gcc
      - devtoolset-7-gcc-c++ # some software wants a newer gcc
      - devtoolset-7-gcc-gfortran # some software wants a newer gcc
      - devtoolset-7-libatomic-devel.x86_64 # needed by seqwish/0.6
      - emacs
      - environment-modules
      - fftw-devel.x86_64 # for gromacs
      - firefox # Dedan swears that he needs this
      - gcc-c++ # for some R libraries
      - gdal-devel.x86_64 # for some R libraries
      - gdal.x86_64 #for libgdal.so.1
      - geos-devel # for some R libraries
      - glib.x86_64 # for wise / Cegma
      - gnuplot.x86_64
      - graphviz
      - gsl # for fastSTRUCTURE
      - gsl-devel.x86_64 # needed for some R packages like HiCeekR
      - hdf5-devel # for some R libraries
      - htop
      - java-1.8.0-openjdk # for lots of stuff
      - java-1.8.0-openjdk-devel # for lots of stuff
      - lapack.x86_64 # for presto
      - libXtst # for some X apps like CLC Genomics
      - libcurl-devel # for some R libraries
      - libgfortran # for R
      - libgit2-devel.x86_64 # needed for some R packages like devtools
      - libgomp # for R
      - libicu # for R
      - libjpeg-turbo-devel.x86_64 # needed for some R packages like HiCeekR
      - libpng12.x86_64 # for pre-compiled blat binary
      - libstdc++.i686 # for 32-bit binaries
      - libtool-ltdl.x86_64 # for pandaseq/2.7
      - libwebp-devel # for some R libraries
      - libxml2-devel # for some R libraries
      - libzstd-devel # for some R libraries
      - mailx.x86_64
      - mesa-libGLU-devel.x86_64 # for some R libraries
      - mpich-3.2-devel.x86_64 # for maker
      - nano
      - numpy # for Trinity as of v2.6.6
      - openblas.x86_64 #for scipy
      - openmpi3 # optional for abyss
      - pandoc.x86_64
      - pango-devel.x86_64 # for genometools and others
      - pcre2-devel.x86_64 # needed as of R/4.0
      - perl-Clone.x86_64 # for circos, see: https://hpc.ilri.cgiar.org/circos-software
      - perl-Config-General.noarch # for circos
      - perl-DBD-mysql # for vep
      - perl-DBI # for vep, see: https://hpc.ilri.cgiar.org/vep-software
      - perl-Env.noarch # for masurca
      - perl-File-Which.noarch # for repeatmodeler/2.0.1
      - perl-Font-TTF.noarch # for circos
      - perl-GD.x86_64 # for circos
      - perl-JSON # for vep
      - perl-LWP-Protocol-https.noarch # so perl can use https
      - perl-Math-Round.noarch # for circos
      - perl-PDF-API2.noarch # for mirdeep2
      - perl-PerlIO-gzip # for vep
      - perl-Readonly.noarch # for circos
      - perl-Regexp-Common.noarch # for circos
      - perl-Regexp-Common.noarch # for circos
      - perl-Statistics-Basic.noarch # for circos
      - perl-Text-Format.noarch # for circos
      - perl-Text-Soundex.x86_64 # for RepeatMasker
      - perl-Time-Piece # for purge_haplotigs/1.1.1
      - perl-parent # for some BioPerl scripts
      - pigz # for SeqKit
      - proj-devel.x86_64 # for some R libraries
      - proj-epsg.x86_64 # for some R libraries
      - proj.x86_64 #for libproj.so.0
      - python3
      - python3-setuptools # needed by some Python scripts to load entrypoint
      - rh-nodejs12-nodejs.x86_64 # needed by nextclade
      - screen #terminal window manager
      - singularity # from EPEL, for viralrecon pipeline
      - sqlite-devel # for some R libraries
      - tbb-devel.x86_64 # for flexbar
      - tmpwatch.x86_64
      - udunits2-devel # for some R libraries
      - wget
      - xauth # or else X11 forwarding doesn't work
      - xeyes # to test x11 :)
      - xz-compat-libs.x86_64 # for samtools/1.5 compiled on CentOS 6
  tags: packages

# 2022-04-21: currently missing from CentOS 8:
#   - compat-libstdc++-33.x86_64
#   - argtable.x86_64 # for clustalo
#   - proj-epsg.x86_64 # for some R libraries
- name: Set extra packages fact for CentOS 8
  when: ansible_distribution_major_version is version('8','==')
  set_fact:
    extra_packages:
      - boost-devel.x86_64 # for augustus
      - boost-iostreams.x86_64 # for augustus
      - cairo-devel.x86_64 # for genometools and others
      - emacs.x86_64
      - environment-modules.x86_64
      - fftw-devel.x86_64 # for gromacs
      - firefox.x86_64
      - gcc-c++.x86_64 # for some R libraries
      - gdal-devel.x86_64 # for some R libraries
      - gdal.x86_64 #for libgdal.so.1
      - geos-devel.x86_64 # for some R libraries
      - glib2.x86_64 # for wise / Cegma
      - gnuplot.x86_64
      - graphviz
      - gsl.x86_64 # for fastSTRUCTURE
      - hdf5-devel.x86_64 # for some R libraries
      - htop.x86_64
      - java-1.8.0-openjdk.x86_64 # for lots of stuff
      - lapack.x86_64 # for presto
      - libXtst.x86_64 # for some X apps like CLC Genomics
      - libcurl-devel.x86_64 # for some R libraries
      - libgfortran.x86_64 # for R
      - libgfortran4-8.3.1-2.1.1.el7.x86_64 # for R compiled on CentOS 7 (in ILRI repo)
      - libgomp.x86_64 # for R
      - libicu.x86_64 # for R
      - libpng12.x86_64 # for pre-compiled blat binary
      - libstdc++.i686 # for 32-bit binaries
      - libtool-ltdl.x86_64 # for pandaseq/2.7
      - libwebp-devel.x86_64 # for some R libraries
      - libxml2-devel.x86_64 # for some R libraries
      - libzstd-devel.x86_64 # for some R libraries
      - mesa-libGLU-devel.x86_64 # for some R libraries
      - nano.x86_64
      - openblas.x86_64 #for scipy
      - openmpi.x86_64 # optional for abyss
      - pandoc.x86_64
      - pango-devel.x86_64 # for genometools and others
      - perl-Clone.x86_64 # for circos, see: https://hpc.ilri.cgiar.org/circos-software
      - perl-Config-General.noarch # for circos
      - perl-DBD-MySQL.x86_64 # for vep
      - perl-DBI.x86_64 # for vep, see: https://hpc.ilri.cgiar.org/vep-software
      - perl-Env.noarch # for masurca
      - perl-Font-TTF.noarch # for circos
      - perl-JSON.noarch # for vep
      - perl-LWP-Protocol-https.noarch # so perl can use https
      - perl-PerlIO-gzip.x86_64 # for vep
      - perl-Readonly.noarch # for circos
      - perl-Text-Soundex.x86_64 # for RepeatMasker
      - perl-parent.noarch # for some BioPerl scripts
      - pigz.x86_64 # for SeqKit
      - proj-devel.x86_64 # for some R libraries
      - proj.x86_64 #for libproj.so.0
      - python3-numpy.x86_64 # for Trinity as of v2.6.6
      - python3-setuptools.noarch # needed by some Python scripts to load entrypoint
      - python36.x86_64
      - screen.x86_64
      - singularity # from EPEL, for viralrecon pipeline
      - sqlite-devel.x86_64 # for some R libraries
      - tbb-devel.x86_64 # for flexbar
      - tmpwatch.x86_64
      - udunits2-devel.x86_64 # for some R libraries
      - wget.x86_64
      - xorg-x11-xauth.x86_64 # or else X11 forwarding doesn't work
  tags: packages

- name: Install extra packages
  ansible.builtin.package:
    name: "{{ extra_packages }}"
    state: present
  tags: packages

- name: Clone environment modules
  ansible.builtin.git:
    repo: https://github.com/ilri/hpc-environment-modules.git
    dest: /etc/modulefiles/ilri
    version: master
  tags: modules

- name: Copy ilri profile script
  ansible.builtin.template:
    src: z-ilri.sh.j2
    dest: /etc/profile.d/z-ilri.sh
    owner: root
    group: root
    mode: 0644
  tags: profile

- name: Copy limits configuration
  ansible.builtin.template:
    src: 90-ilri.conf.j2
    dest: /etc/security/limits.d/90-ilri.conf
    owner: root
    group: root
    mode: 0644
  tags: limits

- name: Copy systemd user.slice override
  ansible.builtin.copy:
    src: etc/systemd/system/user.slice.d/override.conf
    dest: /etc/systemd/system/user.slice.d/override.conf
    owner: root
    group: root
    mode: 0644
  when: inventory_hostname == slurm_head_node
  tags: limits

- name: Remove irqbalance
  ansible.builtin.package:
    name: irqbalance
    state: absent
  tags: irqbalance

- name: Configure global ssh_config on compute nodes
  ansible.builtin.template:
    src: ssh_config.j2
    dest: /etc/ssh/ssh_config
    owner: root
    group: root
    mode: 0644
  tags: ssh-config

- name: Set sticky bit on local scratch
  ansible.builtin.file:
    path: "{{ local_scratch }}"
    group: root
    owner: root
    mode: 01777
    state: directory
  tags: scratch

# TODO: convert to systemd timer
- name: Add cron job to clean up scratch space
  ansible.builtin.template:
    src: cron/cleanup-scratch-space.j2
    dest: /etc/cron.d/2cleanup-scratch-space
    owner: root
    group: root
    mode: 0644
  tags: scratch

# vim: set sw=2 ts=2:

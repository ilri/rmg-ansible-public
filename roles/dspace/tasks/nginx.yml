---

- name: Add nginx.org apt signing key
  ansible.builtin.apt_key:
    url: https://nginx.org/keys/nginx_signing.key
    state: present
  register: add_nginx_apt_key
  tags: packages

- name: Add nginx.org repository
  ansible.builtin.template:
    src: nginx_org_packages_ubuntu.list.j2
    dest: /etc/apt/sources.list.d/nginx_org_packages_ubuntu.list
    mode: 0644
    owner: root
    group: root
  register: add_nginx_apt_repository

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  when:
    add_nginx_apt_key is changed or
    add_nginx_apt_repository is changed

- name: Install nginx
  ansible.builtin.apt:
    pkg: nginx
    cache_valid_time: 3600
    state: present
  tags: packages

- name: Copy nginx configs
  ansible.builtin.copy:
    src: "nginx/{{ item }}"
    dest: "/etc/nginx/{{ item }}"
    mode: 0644
    owner: root
    group: root
  loop:
    - extra-security.conf
    - nginx.conf
    - proxy_params
  notify:
    - reload nginx

- name: Configure nginx dspace vhost
  ansible.builtin.template:
    src: nginx/dspace.conf.j2
    dest: /etc/nginx/conf.d/dspace.conf
    mode: 0644
    owner: root
    group: root
  notify:
    - reload nginx

- name: Configure nginx munin vhost
  ansible.builtin.copy:
    src: nginx/munin.conf
    dest: /etc/nginx/conf.d/munin.conf
    mode: 0644
    owner: root
    group: root
  notify:
    - reload nginx

# Run some common things from the web role, like installing certbot and configu-
# ring nginx TLS settings, default vhost, etc.
- include_role:
    name: web
  tags: letsencrypt

- name: Start and enable nginx service
  ansible.builtin.systemd:
    name: nginx
    state: started
    enabled: true

# vim: set sw=2 ts=2:

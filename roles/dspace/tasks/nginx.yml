---

- name: Add nginx.org apt signing key
  apt_key: url=http://nginx.org/keys/nginx_signing.key state=present

- name: Add nginx.org repo
  template: src=nginx_org_packages_ubuntu.list.j2 dest=/etc/apt/sources.list.d/nginx_org_packages_ubuntu.list mode=0644 owner=root group=root

- name: Install nginx
  apt: pkg=nginx update_cache=yes state=latest

- name: Copy nginx configs
  copy: src=nginx/{{ item }} dest=/etc/nginx/{{ item }} mode=0644 owner=root group=root
  with_items:
    - extra-security.conf
    - nginx.conf
    - proxy_params
  notify:
    - reload nginx

- name: Configure nginx vhosts
  template: src=nginx/default.conf.j2 dest=/etc/nginx/conf.d/default.conf mode=0644 owner=root group=root
  notify:
    - reload nginx

- name: Configure munin vhost
  copy: src=nginx/munin.conf dest=/etc/nginx/conf.d/munin.conf mode=0644 owner=root group=root
  when: munin_role is defined and munin_role == "standalone"
  notify:
    - reload nginx

- name: Generate 2048-bit dhparam
  command: openssl dhparam -out dhparam.pem 2048 chdir=/etc/ssl/certs creates=dhparam.pem

- name: Start & enable nginx service
  service: name=nginx state=started enabled=yes

# vim: set sw=2 ts=2:
